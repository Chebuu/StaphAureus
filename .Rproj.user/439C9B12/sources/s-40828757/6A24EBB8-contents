---
title: "EDA-III"
output: rmarkdown::github_document

---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  error = FALSE,
  eval = FALSE,
  comment = "#>",
  fig.align='center'
)
```


```{r setup, echo=T, eval=F}
devtools::install_github('chebuu/StaphAureus')
library(StaphAureus)

library(dplyr)
library(ggplot2)
library(kableExtra)
```

```{r internal, eval=T, include=F}
library(StaphAureus)
library(dplyr)
library(ggplot2)
library(kableExtra)
```

#### Cohort COAG(+)/COAG(-)

```{sql coagp, eval = F}
with cpos as (
  select * from microbiologyevents 
  where interpretation is not null 
    and org_name ilike '%STAPH%+%'
),

cneg as (
  select * from microbiologyevents 
  where interpretation is not null 
    and org_name ilike '%STAPH%NEG%'
)

select distinct pt.subject_id from patients pt
left join cneg n on n.subject_id = pt.subject_id
left join cpos p on n.subject_id = p.subject_id
```

```{r cohort, echo=T, eval=T, fig.width=5}
cohort <- bind_rows(
  read.csv(
    system.file('extdata/microbio_coagn.csv', package = 'MIMICMicrobiology')
  ),
  read.csv(
    system.file('extdata/microbio_coagp.csv', package = 'MIMICMicrobiology')
  )
)

cohort.n <- length(unique(cohort$subject_id))

(
  cohort.table <<- cohort %>%
  distinct_at(
    vars(subject_id, org_name, isolate_num)
  ) %>%
  mutate(
    org_name = case_when(
      grepl('NEG', org_name) ~ 'COAG (-)',
      grepl('+', org_name)   ~ 'COAG (+)'
    )
  )
) %>%
ggplot(aes(x=isolate_num)) +
  geom_histogram(stat='count') +
  facet_grid(~org_name) +
  theme_bw() 


```
```{r cohort_kab, eval=T, echo=F, fig.align='right'}

kable(
  cohort.table %>% head(6),
  caption = sprintf('(N=%s)', cohort.n),
  format = 'pipe', align = 'r'
)

```

NOTE: `308	STAPHYLOCOCCUS, COAGULASE NEGATIVE, PRESUMPTIVELY NOT S. SAPROPHYTICUS`
